var user_lat;
var user_long;
var map;

function pin_at_position(latitude, longitude) {
  loc = {lat: latitude, lng: longitude};
  marker = new google.maps.Marker({
    position: loc,
    map: map
  })
}

function set_all_pins(locations_hash) {
  for (var i = 0; i < locations_hash.length; i++) {
    pin_at_position(locations_hash[i].latitude, locations_hash[i].longitude);
  }
}

function init_position_success(user_position) {

  //get the current user's location
  user_lat = user_position.coords.latitude;
  user_long = user_position.coords.longitude;

  // update this location in the db with a POST
  $.ajax({
    url: "users/update_current_user_location",
    type: "POST",
    dataType:"json",
    data: {longitude: user_long, latitude: user_lat}
  });

  //create the map
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: user_lat, lng: user_long},
    zoom: 14
  });
  map.setMapTypeId("satellite");

  // make a GET request for all user's locations
  $.ajax({
    url: "users/get_user_locations",
    type: "GET",
    dataType: "json",
    success: set_all_pins
  });
}

function initMap() {
  navigator.geolocation.getCurrentPosition(init_position_success);
}


$(document).ready(function(){
  $("#test_btn").click(function() {
    //draw a line between 400 Ortega Avenue and 164 Orchard Park Drive

    // need to make a geocoding request
    coords = [
      {lat: 38.541383, lng: -121.761078},
      {lat: 14.259155, lng: -3.389085}
    ];

    line = new google.maps.Polyline({
      path: coords,
      geodesic: true,
      strokeColor: '#FF0000',
      strokeOpacity: 1.0,
      strokeWeight: 2
    });

    line.setMap(map);
  })
});
